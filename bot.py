import urllib.request
import urllib.parse
import json
import time
from datetime import datetime

BOT_TOKEN = '8086950668:AAFPUcf3FINRtaHt9mtGJXfjdf5loOZwlTo'
BASE_URL = f'https://api.telegram.org/bot{BOT_TOKEN}'

# –•—Ä–∞–Ω–∏–ª–∏—â–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
user_data = {}

def set_bot_commands():
    """–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ–º–∞–Ω–¥ –º–µ–Ω—é –±–æ—Ç–∞"""
    url = f'{BASE_URL}/setMyCommands'
    commands = [
        {
            "command": "start",
            "description": "–ù–∞—á–∞—Ç—å –∞–∫—Ü–∏—é '–ü–æ–µ–∑–¥ –ß—É–¥–µ—Å'"
        },
        {
            "command": "callback",
            "description": "–û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å —Å –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä–∞–º–∏"
        }
    ]
    payload = {
        "commands": commands
    }
    return make_request(url, payload)

def make_request(url, data=None, method='POST'):
    """–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è HTTP –∑–∞–ø—Ä–æ—Å–æ–≤"""
    if data and method == 'POST':
        data = json.dumps(data).encode('utf-8')
        req = urllib.request.Request(url, data=data, headers={'Content-Type': 'application/json'})
    else:
        req = urllib.request.Request(url)
    
    try:
        with urllib.request.urlopen(req, timeout=30) as response:
            return json.loads(response.read().decode('utf-8'))
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞: {e}")
        return None

def send_message(chat_id, text, reply_markup=None, parse_mode='HTML'):
    """–û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é"""
    url = f'{BASE_URL}/sendMessage'
    payload = {
        'chat_id': chat_id,
        'text': text,
        'parse_mode': parse_mode
    }
    
    if reply_markup:
        payload['reply_markup'] = reply_markup
    
    return make_request(url, payload)

def edit_message_reply_markup(chat_id, message_id, reply_markup=None):
    """–ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è (—É–¥–∞–ª–µ–Ω–∏–µ –∫–Ω–æ–ø–æ–∫)"""
    url = f'{BASE_URL}/editMessageReplyMarkup'
    payload = {
        'chat_id': chat_id,
        'message_id': message_id
    }
    
    if reply_markup is not None:
        payload['reply_markup'] = reply_markup
    
    return make_request(url, payload)

def get_updates(offset=None):
    """–ü–æ–ª—É—á–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –æ—Ç Telegram"""
    url = f'{BASE_URL}/getUpdates'
    params = {'timeout': 30}
    if offset:
        params['offset'] = offset
    
    url_with_params = f"{url}?{urllib.parse.urlencode(params)}"
    return make_request(url_with_params, method='GET')

def answer_callback_query(callback_query_id):
    """–û—Ç–≤–µ—Ç –Ω–∞ callback query"""
    url = f'{BASE_URL}/answerCallbackQuery'
    payload = {'callback_query_id': callback_query_id}
    return make_request(url, payload)

def handle_start_command(chat_id, user_first_name):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã /start"""
    # –°–æ–∑–¥–∞–µ–º –∏–Ω–ª–∞–π–Ω-–∫–Ω–æ–ø–∫–∏
    keyboard = {
        'inline_keyboard': [
            [
                {'text': '–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –∞–∫—Ü–∏—é!', 'callback_data': 'welcome'}
            ],
            [
                {'text': '–ü–µ—Ä–µ–π—Ç–∏ –≤ –∫–∞–Ω–∞–ª –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä–æ–≤', 'url': 'https://t.me/poyezd_chudes'}
            ]
        ]
    }
    
    welcome_text = (
        f"–ü—Ä–∏–≤–µ—Ç, {user_first_name}!\n\n"
        "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –∞–∫—Ü–∏—é \"–ü–æ–µ–∑–¥ –ß—É–¥–µ—Å\" üöÇüéÑüéÅ\n"
        "–ó–¥–µ—Å—å –≤—ã –º–æ–∂–µ—Ç–µ –≤—ã–±—Ä–∞—Ç—å –∂–µ–ª–∞–Ω–∏–µ —Ä–µ–±—ë–Ω–∫–∞ –∏ –ø–æ–¥–∞—Ä–∏—Ç—å –ø—Ä–∞–∑–¥–Ω–∏–∫."
    )
    
    send_message(chat_id, welcome_text, reply_markup=keyboard)

def handle_callback_command(chat_id):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã /callback"""
    send_message(chat_id, "–û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å —Å–æ —Å—Ç–æ—Ä–æ–Ω—ã –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä–æ–≤ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç—É—Ç @poyezd_chudes")

def handle_welcome_callback(chat_id, message_id, callback_query_id):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏—è –Ω–∞ –∫–Ω–æ–ø–∫—É '–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –∞–∫—Ü–∏—é!'"""
    # –û—Ç–≤–µ—á–∞–µ–º –Ω–∞ callback query
    answer_callback_query(callback_query_id)
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
    send_message(chat_id, "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞–ø–∏—à–∏—Ç–µ –Ω–æ–º–µ—Ä –∫–æ–Ω–≤–µ—Ä—Ç–∞, –∫–æ—Ç–æ—Ä—ã–π –≤—ã –≤—ã–±—Ä–∞–ª–∏.")
    
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    if chat_id not in user_data:
        user_data[chat_id] = {}
    user_data[chat_id]['state'] = 'waiting_envelope'

def handle_envelope(chat_id, text):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–æ–º–µ—Ä–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∞"""
    if text.isdigit():
        user_data[chat_id]['number'] = int(text)
        user_data[chat_id]['state'] = 'waiting_phone'
        send_message(chat_id, "–°–ø–∞—Å–∏–±–æ! –¢–µ–ø–µ—Ä—å –Ω–∞–ø–∏—à–∏—Ç–µ –≤–∞—à –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏.")
    else:
        send_message(chat_id, "–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –≤–≤–æ–¥ –Ω–æ–º–µ—Ä–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.")

def handle_phone(chat_id, text):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞"""
    phone = text.strip()
    # –ü—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
    if len(phone) >= 10 and (phone.startswith('+') or phone.startswith('8') or phone.isdigit()):
        user_data[chat_id]['phone'] = phone
        
        # –°–æ–∑–¥–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –∫–Ω–æ–ø–∫–∞–º–∏ –î–∞/–ù–µ—Ç
        keyboard = {
            'keyboard': [
                [{'text': '–î–∞'}],
                [{'text': '–ù–µ—Ç'}]
            ],
            'resize_keyboard': True,
            'one_time_keyboard': True
        }
        
        number = user_data[chat_id]['number']
        phone_number = user_data[chat_id]['phone']
        
        confirmation_message = f"–í–∞—à –∫–æ–Ω–≤–µ—Ä—Ç ‚Ññ{number}, –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞: {phone_number}. –í—Å–µ –≤–µ—Ä–Ω–æ?"
        send_message(chat_id, confirmation_message, reply_markup=keyboard)
        user_data[chat_id]['state'] = 'waiting_confirmation'
    else:
        send_message(chat_id, "–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞. –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–æ–ø—ã—Ç–∫—É.")

def handle_confirmation(chat_id, text):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è"""
    if text.lower() == '–¥–∞':
        number = user_data[chat_id]['number']
        send_message(chat_id, f"–°—É–ø–µ—Ä! –í–∞—à –∫–æ–Ω–≤–µ—Ä—Ç ‚Ññ{number} –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω. –û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å —Å–æ —Å—Ç–æ—Ä–æ–Ω—ã –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä–æ–≤ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç—É—Ç @poyezd_chudes. –°–ø–∞—Å–∏–±–æ –∑–∞ —É—á–∞—Å—Ç–∏–µ!")
        print(f"–î–∞–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∞–Ω—ã: –∫–æ–Ω–≤–µ—Ä—Ç {number}, —Ç–µ–ª–µ—Ñ–æ–Ω {user_data[chat_id]['phone']}")
        # –£–¥–∞–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        if chat_id in user_data:
            del user_data[chat_id]
    elif text.lower() == '–Ω–µ—Ç':
        send_message(chat_id, "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –∑–∞–Ω–æ–≤–æ.")
        # –°–±—Ä–∞—Å—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        if chat_id in user_data:
            user_data[chat_id] = {'state': 'waiting_envelope'}
        send_message(chat_id, "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞–ø–∏—à–∏—Ç–µ –Ω–æ–º–µ—Ä –∫–æ–Ω–≤–µ—Ä—Ç–∞, –∫–æ—Ç–æ—Ä—ã–π –≤—ã –≤—ã–±—Ä–∞–ª–∏.")
    else:
        send_message(chat_id, "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ '–î–∞' –∏–ª–∏ '–ù–µ—Ç'.")

def process_message(update):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è"""
    if 'message' in update:
        message = update['message']
        chat_id = message['chat']['id']
        text = message.get('text', '')
        user_first_name = message['from'].get('first_name', '–¥—Ä—É–≥')
        
        # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã /start
        if text == '/start':
            handle_start_command(chat_id, user_first_name)
            # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            if chat_id in user_data:
                del user_data[chat_id]
            return
        
        # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã /callback
        elif text == '/callback':
            handle_callback_command(chat_id)
            return
        
        # –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–±—ã—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏—è
        if chat_id in user_data:
            state = user_data[chat_id].get('state', '')
            
            if state == 'waiting_envelope':
                handle_envelope(chat_id, text)
            elif state == 'waiting_phone':
                handle_phone(chat_id, text)
            elif state == 'waiting_confirmation':
                handle_confirmation(chat_id, text)
            else:
                # –ï—Å–ª–∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
                handle_start_command(chat_id, user_first_name)
        else:
            # –ï—Å–ª–∏ –Ω–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏—è, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
            handle_start_command(chat_id, user_first_name)

def process_callback_query(update):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ callback-–∑–∞–ø—Ä–æ—Å–∞ –æ—Ç –∏–Ω–ª–∞–π–Ω-–∫–Ω–æ–ø–æ–∫"""
    callback_query = update['callback_query']
    chat_id = callback_query['message']['chat']['id']
    message_id = callback_query['message']['message_id']
    callback_data = callback_query['data']
    callback_query_id = callback_query['id']
    
    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –∞–∫—Ü–∏—é!"
    if callback_data == 'welcome':
        handle_welcome_callback(chat_id, message_id, callback_query_id)

def main():
    """–û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª –±–æ—Ç–∞"""
    print(f"–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω! {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–∫–µ–Ω
    if BOT_TOKEN == '–í–ê–®_–¢–û–ö–ï–ù_–ë–û–¢–ê':
        print("–û–®–ò–ë–ö–ê: –ó–∞–º–µ–Ω–∏—Ç–µ '–í–ê–®_–¢–û–ö–ï–ù_–ë–û–¢–ê' –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π —Ç–æ–∫–µ–Ω –æ—Ç @BotFather!")
        print("–ü—Ä–∏–º–µ—Ä: BOT_TOKEN = '1234567890:AAFmEXAMPLE_TOKEN_HERE'")
        return
    
    print(f"–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–∫–µ–Ω: {BOT_TOKEN[:10]}...")
    
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–º–∞–Ω–¥—ã –º–µ–Ω—é –±–æ—Ç–∞
    print("–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é –∫–æ–º–∞–Ω–¥—ã –º–µ–Ω—é...")
    result = set_bot_commands()
    if result and result.get('ok'):
        print("–ö–æ–º–∞–Ω–¥—ã –º–µ–Ω—é —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!")
    else:
        print(f"–û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∫–æ–º–∞–Ω–¥: {result}")
    
    offset = None
    
    while True:
        try:
            updates = get_updates(offset)
            
            if updates and 'result' in updates:
                for update in updates['result']:
                    offset = update['update_id'] + 1
                    
                    # –û–±—Ä–∞–±–æ—Ç–∫–∞ callback-–∑–∞–ø—Ä–æ—Å–æ–≤ (–Ω–∞–∂–∞—Ç–∏–µ –Ω–∞ –∏–Ω–ª–∞–π–Ω-–∫–Ω–æ–ø–∫–∏)
                    if 'callback_query' in update:
                        process_callback_query(update)
                    # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
                    elif 'message' in update:
                        process_message(update)
            
            # –ù–µ–±–æ–ª—å—à–∞—è –ø–∞—É–∑–∞ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏
            time.sleep(0.5)
            
        except KeyboardInterrupt:
            print("\n–ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.")
            break
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞: {e}")
            time.sleep(5)

if __name__ == '__main__':
    main()